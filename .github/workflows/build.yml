name: Build, Test and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘è„šæœ¬
  build:
    runs-on: ubuntu-latest
    outputs:
      has_scripts: ${{ steps.check.outputs.files_exists }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Pure Bash Scripts
        run: |
          # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† <<'EOF'ï¼Œé˜²æ­¢ Bash æå‰è§£æåæ–œæ 
          python3 <<'EOF'
          import os

          output_dir = "output"
          os.makedirs(output_dir, exist_ok=True)

          files = {'1_pre': 'pre.sh', '2_chroot': 'chroot.sh', '3_post': 'post.sh', '4_hx_cpp': 'hx_cpp.sh'}
          
          # æ³¨æ„ï¼šåœ¨ Python é‡Œï¼Œæˆ‘ä»¬è¦ç”Ÿæˆçš„è„šæœ¬å†…å®¹ä¹Ÿè¦æ³¨æ„ $ ç¬¦å·çš„è½¬ä¹‰
          template_header = r"""#!/bin/bash
          LOG="install.log"
          SUCCESS=0
          FAIL=0
          FAILED_LIST=()

          run_task() {
              local desc="$1"
              local cmd="$2"
              echo -e "\033[1;34m[ä»»åŠ¡æè¿°]\033[0m"
              echo -e "\033[1;36m$desc\033[0m"
              echo -e "\033[1;30m[æ‰§è¡Œå‘½ä»¤] $cmd\033[0m"
              
              if eval "$cmd" >> "$LOG" 2>&1; then
                  echo -e "\033[1;32mâœ… æˆåŠŸ\033[0m"
                  ((SUCCESS++))
              else
                  echo -e "\033[1;31mâŒ å¤±è´¥\033[0m"
                  ((FAIL++))
                  FAILED_LIST+=("$desc")
              fi
              echo "-----------------------------------"
          }

          echo "å¼€å§‹æ‰§è¡Œå®‰è£…æµç¨‹..."
          echo "==================================="
          """

          for src, out in files.items():
              src_file = f"{src}.hx.config.sh"
              if not os.path.exists(src_file): continue
              
              with open(src_file, 'r') as f:
                  blocks = [b.strip() for b in f.read().split('\n\n') if b.strip()]
              
              tasks = []
              for block in blocks:
                  lines = block.split('\n')
                  comments = []
                  cmds = []
                  for l in lines:
                      l = l.strip()
                      if not l: continue
                      if l.startswith('#'):
                          comments.append(l.lstrip('# ').strip())
                      else:
                          cmds.append(l)
                  
                  if not cmds: continue
                  
                  # æ ¸å¿ƒä¿®å¤ç‚¹ï¼š
                  # 1. æè¿°ä¸­çš„æ¢è¡Œç¬¦ä½¿ç”¨æ–‡å­— \nï¼ŒBash çš„ echo -e ä¼šè§£æå®ƒ
                  # 2. åªéœ€è¦å¯¹åŒå¼•å·è¿›è¡Œä¸€æ¬¡è½¬ä¹‰ \" å³å¯ï¼Œé˜²æ­¢ç ´å run_task çš„å¼•å·ç»“æ„
                  full_desc = "\\n".join(comments).replace('"', '\\"')
                  full_cmd = " && ".join(cmds).replace('"', '\\"')
                  
                  tasks.append(f'run_task "{full_desc}" "{full_cmd}"')

              with open(os.path.join(output_dir, out), 'w') as f_out:
                  f_out.write(template_header)
                  f_out.write("\n".join(tasks))
                  f_out.write('\necho -e "\\n==================================="')
                  f_out.write('\necho -e "å®‰è£…å®Œæˆ! æˆåŠŸ: $SUCCESS, å¤±è´¥: $FAIL"')
                  f_out.write('\nif [ $FAIL -ne 0 ]; then echo -e "\\033[1;31må¤±è´¥é¡¹:\\033[0m"; for item in "${FAILED_LIST[@]}"; do echo " - $item"; done; fi\n')
          EOF

      - name: Upload artifacts for testing
        uses: actions/upload-artifact@v4
        with:
          name: generated-scripts
          path: output/

  # ç¬¬äºŒé˜¶æ®µï¼šåœ¨ Arch Linux å®¹å™¨ä¸­è¿›è¡Œå†’çƒŸæµ‹è¯•
  test:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install Test Dependencies
        run: |
          pacman -Sy --noconfirm
          # å®‰è£…ä½ è„šæœ¬ä¸­å¯èƒ½ç”¨åˆ°çš„åŸºç¡€å‘½ä»¤ï¼Œç¡®ä¿ eval èƒ½å¤Ÿè¿è¡Œ
          pacman -S --noconfirm sed grep coreutils

      - name: Download generated scripts
        uses: actions/download-artifact@v4
        with:
          name: generated-scripts
          path: scripts/

      - name: Run Smoke Test
        run: |
          # æµ‹è¯•æ‰€æœ‰ç”Ÿæˆçš„è„šæœ¬æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
          # æ³¨æ„ï¼šæ¶‰åŠç¡¬ä»¶çš„æ“ä½œåœ¨å®¹å™¨å†…ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬ä¸»è¦æ£€æŸ¥è¯­æ³•é€»è¾‘
          cd scripts/
          for script in *.sh; do
            echo "æ­£åœ¨æµ‹è¯• $script ..."
            # ä½¿ç”¨ bash -n æ£€æŸ¥è¯­æ³•é”™è¯¯
            bash -n "$script"
            # å°è¯•è¿è¡Œï¼ˆå¯èƒ½ä¼šå› ä¸ºç¯å¢ƒé™åˆ¶å¤±è´¥ï¼Œä½†è¿™èƒ½æµ‹è¯•å‡º eval çš„é€»è¾‘ï¼‰
            # æˆ‘ä»¬é€šè¿‡è¿™ç§æ–¹å¼ç¡®ä¿ç”Ÿæˆçš„è„šæœ¬ä¸æ˜¯ä¸€å †ä¹±ç 
            bash "$script" || echo "è„šæœ¬è¿è¡Œä¸­è§¦å‘äº†é¢„æœŸå†…çš„ç¯å¢ƒå—é™é”™è¯¯ï¼Œä½†è¯­æ³•é€šè¿‡ã€‚"
          done

  # ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²ï¼ˆä»…åœ¨æµ‹è¯•é€šè¿‡åæ‰§è¡Œï¼‰
  deploy:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build results
        uses: actions/download-artifact@v4
        with:
          name: generated-scripts
          path: output/

      - name: Deploy to Dist Branch ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: output
          branch: dist
          clean: true
          single-commit: true
