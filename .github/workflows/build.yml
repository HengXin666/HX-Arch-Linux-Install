name: Compile Arch Scripts

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Pure Bash Scripts
        run: |
          python3 <<EOF
          import os

          files = {'1_pre': 'pre.sh', '2_chroot': 'chroot.sh', '3_post': 'post.sh', '4_hx_cpp': 'hx_cpp.sh'}
          
          template_header = """#!/bin/bash
          LOG="install.log"
          SUCCESS=0
          FAIL=0
          FAILED_LIST=()

          run_task() {
              local desc="\$1"
              local cmd="\$2"
              echo -e "\\033[1;34m[ä»»åŠ¡æè¿°]\\033[0m"
              echo -e "\\033[1;36m\$desc\\033[0m"
              echo -e "\\033[1;30m[æ‰§è¡Œå‘½ä»¤] \$cmd\\033[0m"
              
              if eval "\$cmd" >> "\$LOG" 2>&1; then
                  echo -e "\\033[1;32mâœ… æˆåŠŸ\\033[0m"
                  ((SUCCESS++))
              else
                  echo -e "\\033[1;31mâŒ å¤±è´¥\\033[0m"
                  ((FAIL++))
                  FAILED_LIST+=("\$desc")
              fi
              echo "-----------------------------------"
          }

          echo "å¼€å§‹æ‰§è¡Œå®‰è£…æµç¨‹..."
          echo "==================================="
          """

          for src, out in files.items():
              if not os.path.exists(src + ".hx.config.sh"): continue
              
              with open(src + ".hx.config.sh", 'r') as f:
                  # æŒ‰ç©ºè¡Œåˆ†å‰²ä»»åŠ¡å—
                  blocks = [b.strip() for b in f.read().split('\n\n') if b.strip()]
              
              tasks = []
              for block in blocks:
                  lines = block.split('\n')
                  comments = []
                  cmds = []
                  for l in lines:
                      l = l.strip()
                      if not l: continue
                      if l.startswith('#'):
                          comments.append(l.lstrip('# ').strip())
                      else:
                          cmds.append(l)
                  
                  if not cmds: continue
                  
                  # å¤šä¸ª # è¡Œä¼šè¢«æ¢è¡Œç¬¦ \n è¿æ¥
                  full_desc = "\\\\n".join(comments) if comments else "æœªå‘½åä»»åŠ¡"
                  full_cmd = " && ".join(cmds)
                  
                  # è½¬ä¹‰åŒå¼•å·ä»¥é˜²ç ´å shell è¯­æ³•
                  full_desc = full_desc.replace('"', '\\\\"')
                  full_cmd = full_cmd.replace('"', '\\\\"')
                  
                  tasks.append(f'run_task "{full_desc}" "{full_cmd}"')

              with open(out, 'w') as f_out:
                  f_out.write(template_header)
                  f_out.write("\n".join(tasks))
                  f_out.write('\necho -e "\\n==================================="')
                  f_out.write('\necho -e "å®‰è£…å®Œæˆ! æˆåŠŸ: $SUCCESS, å¤±è´¥: $FAIL"')
                  f_out.write('\nif [ $FAIL -ne 0 ]; then echo -e "\\033[1;31må¤±è´¥é¡¹:\\033[0m"; for item in "\${FAILED_LIST[@]}"; do echo " - \$item"; done; fi\n')
          EOF
      - name: Deploy to Dist Branch ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: output      # éƒ¨ç½² output æ–‡ä»¶å¤¹ä¸‹çš„å†…å®¹
          branch: dist        # ç›®æ ‡åˆ†æ”¯
          clean: true         # æ¯æ¬¡æ¨é€å‰æ¸…ç†ç›®æ ‡åˆ†æ”¯
          single-commit: true # ä½¿ dist åˆ†æ”¯ä¿æŒåªæœ‰ä¸€ä¸ª commitï¼Œé¿å…å†å²å †ç§¯è¿‡
